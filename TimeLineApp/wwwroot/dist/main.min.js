"use strict";function romanize(n){if(!+n)return null;for(var i=String(+n).split(""),u=["","C","CC","CCC","CD","D","DC","DCC","DCCC","CM","","X","XX","XXX","XL","L","LX","LXX","LXXX","XC","","I","II","III","IV","V","VI","VII","VIII","IX"],t="",r=3;r--;)t=(u[+i.pop()+r*10]||"")+t;return Array(+i.join("")+1).join("M")+t}function LoadTimeLine(){$.ajax("api/storage/load",{data:{fname:$("#files_list").val()}}).done(function(n){var t=new TLEvent_1.TimeLineData(JSON.parse(n)),i=new timeline_1.TimeLine(ctx);i.name=t.Name;i.tldata=t;NewTimeLine(t.Name,i);$("#tmLoadModal").modal("hide")}).fail(function(n){alert("Ошибка загрузки\n"+n.status.toString()+" "+n.statusText+"\n"+n.responseText)})}function OpenLoadTLDialog(){timeline_1.TimeLine.getList().then(function(n){var i=$("#files_list"),t;for(i.find("option").remove(),t=0;t<n.length;t++)i.append($("<option><\/option>",{value:n[t],text:n[t]}));$("#tmLoadModal").modal()}).catch(function(n){alert("Ошибка сервера.\n"+n)})}function NewTimeLine(n,t){var r,u,f,i;if(t===void 0&&(t=null),(timeLines.length+2)*MIN_GAP+(timeLines.length+1)*timeline_1.TimeLine.LINE_THICKNESS>ctx.canvas.clientHeight){alert("Достигнуто максимальное количество линий времени");return}for(r=splitWorkspace(timeLines.length+1),u=timeline_1.TimeLine.getCurPeriod(PERIOD_TYPE),f=colorutils_1.makeColor(),t===null&&(t=new timeline_1.TimeLine(ctx,u,0,0,PERIOD_TYPE,n)),timeLines.push(t),i=0;i<timeLines.length;i++)timeLines[i].y=r[i],timeLines[i].color=f.next().value;drawAll()}function splitWorkspace(n){for(var t=[],i=(ctx.canvas.clientHeight-n*timeline_1.TimeLine.LINE_THICKNESS)/(n+1)+.5,r=0,u=i;r<n;r++,u+=i+timeline_1.TimeLine.LINE_THICKNESS)t.push(u);return t}function getIndexLine(n){for(var t=0;t<timeLines.length;t++)if(n>=timeLines[t].y&&n<timeLines[t].y+timeline_1.TimeLine.LINE_THICKNESS)return t;return-1}function drawAll(){ctx.clearRect(0,0,ctx.canvas.clientWidth,ctx.canvas.clientHeight);for(var n=0;n<timeLines.length;n++)timeLines[n].Period=PERIOD_TYPE,timeLines[n].draw()}function getMousePos(n,t){var i=n.getBoundingClientRect();return{x:t.clientX-i.left,y:t.clientY-i.top}}function OpenNewTLDialog(){$("#tmName").val("");$("#btnNewName").prop("disabled",!0);$("#tmNameModal").modal()}function SwitchPeriod(n,t){n.menu.find(function(n){return n.id==="period"}).sub.forEach(function(n){n.icon=n.id===t?'<i class="fas fa-angle-down"><\/i>':""});PERIOD_TYPE=t;drawAll();n.reload()}var __generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},ContextMenu,ContextUtil,MyHTMLLIElement,stringutils_1,DateUtils,Globals,Globals_1,LogonHandlers,RegisterHandlers,CellData,__extends,dateutils_1,EnumPeriod,TLDate,TLEvent,TLEventDay,TLEventMonth,TLEventYear,TLEventDecade,TLEventCentury,TLPeriod,TimeLineData,TLPeriodEvent;Object.defineProperty(exports,"__esModule",{value:!0});exports.makeColor=function(){var n,t;return __generator(this,function(i){switch(i.label){case 0:n=0;t=["magenta","green","rgba(255, 0, 0, 1.0)","blue","magenta","orange"];i.label=1;case 1:return[4,t[n]];case 2:return i.sent(),n<4?n++:n=0,[3,1];case 3:return[2]}})};__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});ContextMenu=function(){function n(t,i){var r=this,u;this.contextTarget=null;u=n.count++;this.menu=t;this.options=i==undefined?{}:i;window.addEventListener("resize",function(){return r.onresize()});this.reload()}return n.prototype.onresize=function(){ContextUtil.getProperty(this.options,"close_on_resize",!0)&&this.hide()},n.prototype.hide=function(){var t=this;document.getElementById("cm_"+n.count).classList.remove("display");window.removeEventListener("click",function(){return t.documentClick()})},n.prototype.setOptions=function(n){this.options=n},n.prototype.changeOption=function(n,t){this.options[n]=t},n.prototype.getOptions=function(){return this.options},n.prototype.reload=function(){var t,i;document.getElementById("cm_"+n.count)==null&&(t=document.createElement("div"),t.className="cm_container",t.id="cm_"+n.count,document.body.appendChild(t));i=document.getElementById("cm_"+n.count);i.innerHTML="";i.appendChild(this.renderLevel(this.menu))},n.prototype.renderLevel=function(t){var i=this,r=document.createElement("ul");return t.forEach(function(t){var u=document.createElement("li"),e,o,s,h,f;if(u.menu=i,typeof t.type=="undefined")if(e=document.createElement("span"),e.className="cm_icon_span",e.innerHTML=ContextUtil.getProperty(t,"icon","")!=""?ContextUtil.getProperty(t,"icon",""):ContextUtil.getProperty(i.options,"default_icon",""),o=document.createElement("span"),o.className="cm_text",o.innerHTML=ContextUtil.getProperty(t,"text","")!=""?ContextUtil.getProperty(t,"text",""):ContextUtil.getProperty(i.options,"default_text","item"),s=document.createElement("span"),s.className="cm_sub_span",typeof t.sub!="undefined"&&(s.innerHTML=ContextUtil.getProperty(i.options,"sub_icon","")!=""?ContextUtil.getProperty(i.options,"sub_icon",""):"&#155;"),u.appendChild(e),u.appendChild(o),u.appendChild(s),ContextUtil.getProperty(t,"enabled",!0)){if(typeof t.events=="object")for(h=Object.keys(t.events),f=0;f<h.length;f++)u.addEventListener(h[f],t.events[h[f]]);typeof t.sub!="undefined"&&u.appendChild(i.renderLevel(t.sub))}else u.setAttribute("disabled","");else t.type==n.DIVIDER&&(u.className="cm_divider");r.appendChild(u)}),r},n.prototype.display=function(t,i){var v=this,s;this.contextTarget=typeof i!="undefined"?i:t.target;var r=document.getElementById("cm_"+n.count),h={x:t.clientX,y:t.clientY},u=h.x,f=h.y,c=r.offsetWidth+4,l=r.offsetHeight+4,e=window.innerWidth,o=window.innerHeight,a=parseInt(ContextUtil.getProperty(this.options,"mouse_offset",2));r.style.left=e-u<c?e-c+"px":u+a+"px";r.style.top=o-f<l?o-l+"px":f+a+"px";s=ContextUtil.getSizes(r);e-u<s.width?r.classList.add("cm_border_right"):r.classList.remove("cm_border_right");o-f<s.height?r.classList.add("cm_border_bottom"):r.classList.remove("cm_border_bottom");r.classList.add("display");ContextUtil.getProperty(this.options,"close_on_click",!0)&&window.addEventListener("click",function(){v.documentClick()});t.preventDefault()},n.prototype.documentClick=function(){this.hide()},n.count=0,n.DIVIDER="cm_divider",n}();exports.ContextMenu=ContextMenu;ContextUtil=function(){function n(){}return n.getProperty=function(n,t,i){return typeof n[t]!="undefined"?n[t]:i},n.getSizes=function(t){for(var u,o,s,h,a,l,f,e=t.getElementsByTagName("li"),i=0,r=0,c=0;c<e.length;c++)u=e[c],u.offsetWidth>i&&(i=u.offsetWidth),u.offsetHeight>r&&(r=u.offsetHeight);for(o=i,s=r,h=0;h<e.length;h++)a=e[h],l=a.getElementsByTagName("ul"),typeof l[0]!="undefined"&&(f=n.getSizes(l[0]),i+f.width>o&&(o=i+f.width),r+f.height>s&&(s=r+f.height));return{width:o,height:s}},n}();exports.ContextUtil=ContextUtil;MyHTMLLIElement=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return __extends(t,n),t}(HTMLLIElement);__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e};Object.defineProperty(exports,"__esModule",{value:!0});stringutils_1=require("./stringutils");DateUtils=function(){function n(){}return n.YMDFromAD=function(t){var u=0,r,i,e,o,f,s;if(t>0)i=r=1;else if(t<0)i=r=-1;else return null;for(e=Math.abs(t);Math.abs(u)<e;)u+=n.leapYear(r)?366*i:365*i,r+=i;for(r-=i,u-=n.leapYear(r)?366*i:365*i,o=n.leapYear(r)?this.dth_leap:this.dth,f=0;Math.abs(u)<e;)u+=o[f]*i,f++;return f--,u-=o[f]*i,s=Math.abs(t)-Math.abs(u),{year:r,month:f+1,day:s}},n.DaysFromAD=function(t,i,r){for(var f=Math.abs(t),u=0,e=1;e<f;e++)u+=n.leapYear(e)?366:365;return n.leapYear(f)?this.dth_leap.slice(0,i-1).forEach(function(n){u+=n}):this.dth.slice(0,i-1).forEach(function(n){u+=n}),(u+r)*(f/t)},n.getCurDate=function(){var n=new Date;return new Date(n.getFullYear(),n.getMonth(),n.getDate())},n.getDateAgo=function(n,t){var i=new Date(n);return i.setDate(i.getDate()+t),i},n.formatDate=function(n){return stringutils_1.stringUtils.pad(n.getDate(),2)+"."+stringutils_1.stringUtils.pad(n.getMonth()+1,2)+"."+(n.getFullYear()+"").substring(2)},n.getMonthFromDate=function(n){return(n.getFullYear()-1)*12+n.getMonth()+1},n.getNumberFromMonth=function(n,t){var i=n/Math.abs(n);return(n-i)*12+t*i},n.getMonthFromNumber=function(n){var t,i;return n>0?(t=Math.floor(n/12),i={year:t+1,month:n-t*12}):(t=Math.ceil(n/12),i={year:t-1,month:Math.abs(n)-Math.abs(t*12)}),i},n.getYearFromDate=function(n){return n.getFullYear()},n.getDecadeFromDate=function(n){return Math.floor(n.getFullYear()/10)+1},n.getCenturyFromDate=function(n){return Math.floor(n.getFullYear()/100)+1},n.getDecade=function(n,t){return(n-1)*10+t+1},n.formatMonth=function(n){var t=Math.floor((n-1)/12)+1,i=n-(t-1)*12;return this.mth[i-1]+" "+stringutils_1.stringUtils.pad(t,4)},n.formatYear=function(n){return n.toString()},n.formatDecade=function(n){var t=Math.floor((n-1)/10)+1,i=n-(t-1)*10;return romanize(t)+" "+(i-1)*10+"е"},n.formatCentury=function(n){return romanize(n)},n.getDecadeComponent=function(n){var t=Math.floor((n-1)/10)+1;return n-(t-1)*10},n.leapYear=function(n){return n%4==0&&n%100!=0||n%400==0},n.mth=["ЯНВ","ФЕВ","МАР","АПР","МАЙ","ИЮН","ИЮЛ","АВГ","СЕН","ОКТ","НОЯ","ДЕК"],n.dth=[31,28,31,30,31,30,31,31,30,31,30,31],n.dth_leap=[31,29,31,30,31,30,31,31,30,31,30,31],n.makeMonthNumber=function(t,i,r){var f,e,u;return r===void 0&&(r=!1),__generator(this,function(o){switch(o.label){case 0:f=r?-1:1;e=Math.abs(t);u=n.getNumberFromMonth(t,i);o.label=1;case 1:return u+=f,u===0&&(u+=f),[4,n.getMonthFromNumber(u)];case 2:return o.sent(),[3,1];case 3:return[2]}})},n}();exports.DateUtils=DateUtils;Object.defineProperty(exports,"__esModule",{value:!0});Globals=function(){function n(){}return n.getCookie=function(n){var i=document.cookie,t=document.cookie.match(new RegExp("(?:^|; )"+n.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):undefined},n.IsAuthentificated=!1,n}();exports.Globals=Globals;Object.defineProperty(exports,"__esModule",{value:!0});var timeline_1=require("./timeline"),colorutils_1=require("./colorutils"),contextmenu_1=require("./contextmenu"),LogonHandlers_1=require("./LogonHandlers"),RegisterHandlers_1=require("./RegisterHandlers"),TLEvent_1=require("./TLEvent"),MIN_GAP=100,PERIOD_TYPE=TLEvent_1.EnumPeriod.day,HTOP=56,timeLines=[],ctx;(function(){var r=!1,t,u=[{id:"new",text:"Новая",icon:'<i class="far fa-file"><\/i>',events:{click:OpenNewTLDialog}},{id:"load",text:"Загрузить",icon:'<i class="far fa-folder-open"><\/i>',events:{click:OpenLoadTLDialog}},{id:"save",text:"Сохранить",icon:'<i class="far fa-save"><\/i>',enabled:!1,events:{click:function(){return timeLines[t].save()}}},{id:"line",type:contextmenu_1.ContextMenu.DIVIDER},{id:"period",text:"Периодичность",sub:[{id:TLEvent_1.EnumPeriod.day,text:"День",icon:'<i class="fas fa-angle-down"><\/i>',events:{click:function(){return SwitchPeriod(i,TLEvent_1.EnumPeriod.day)}}},{id:TLEvent_1.EnumPeriod.month,text:"Месяц",events:{click:function(){return SwitchPeriod(i,TLEvent_1.EnumPeriod.month)}}},{id:TLEvent_1.EnumPeriod.year,text:"Год",events:{click:function(){return SwitchPeriod(i,TLEvent_1.EnumPeriod.year)}}},{id:TLEvent_1.EnumPeriod.decade,text:"Десятилетие",events:{click:function(){return SwitchPeriod(i,TLEvent_1.EnumPeriod.decade)}}},{id:TLEvent_1.EnumPeriod.century,text:"Век",events:{click:function(){return SwitchPeriod(i,TLEvent_1.EnumPeriod.century)}}}]}],i=new contextmenu_1.ContextMenu(u),n=document.getElementById("canvas");ctx=n.getContext("2d");n.onmousedown=function(i){if(i.button===0){var u=getMousePos(n,i);t=getIndexLine(u.y);t!==-1&&(r=!0,n.style.cursor="Pointer")}};n.onmouseup=function(){r=!1;n.style.cursor="Default"};n.onmousemove=function(i){var f,u,e;if(r)timeLines[t].shift(i.movementX),timeLines[t].draw();else for(u=0;u<timeLines.length;u++)if(e=getMousePos(n,i),f=timeLines[u].getCellValue(e.x,e.y),f!==timeLines[u].curdata){if(timeLines[u].curdata!==-1&&timeLines[u].offBox(),f!==-1)timeLines[u].onBox(f);timeLines[u].curdata=f}};(window.onresize=function(){n.style.top=HTOP+"px";n.width=window.innerWidth;n.height=window.innerHeight-HTOP;drawAll()})();$("#canvas").on("contextmenu",function(r){var f=getMousePos(n,r),u;t=getIndexLine(f.y);u=i.menu.find(function(n){return n.id==="save"});t===-1?u.enabled=!1:(u.enabled=!0,u.events={click:function(){timeLines[t].save()}});i.reload();i.display(r);r.preventDefault()});$("#newTimeline").click(function(){OpenNewTLDialog()});$("#load").click(function(){LoadTimeLine()});$("#save").click(function(){alert("save")});$("#options").click(function(){$("#typePeriod").val(TLEvent_1.EnumPeriod.year);$("#tmOptionsModal").modal()});$("#btnNewName").click(function(){$("#tmNameModal").modal("hide");NewTimeLine($("#tmName").val())});$(".closenamemodal").click(function(){$("#tmNameModal").modal("hide")});$(".closeoptionmodal").click(function(){$("#tmOptionsModal").modal("hide")});$(".closeregistermodal").click(function(){$("#tmRegisterModal").modal("hide")});$(".closeloginmodal").click(function(){$("#tmLoginModal").modal("hide")});$(".closeloadmodal").click(function(){$("#tmLoadModal").modal("hide")});$("#tmName").keyup(function(n){$("#tmName").val().trim()!==""?($("#btnNewName").prop("disabled",!1),n.keyCode===13&&($("#tmNameModal").modal("hide"),NewTimeLine($("#tmName").val()))):$("#btnNewName").prop("disabled",!0)});$("#tmNameModal").on("shown.bs.modal",function(){$("#tmName").trigger("focus")});$("#action01").click(function(){alert("action01")});$("#regPassword1").focus(function(){$("#passw_not_matches").css("display","none")});$("#regPassword2").focus(function(){$("#passw_not_matches").css("display","none")});$("#logPassword").focus(function(){$("#log_server_error").css("display","none")});$("#btnReg").click(RegisterHandlers_1.RegisterHandlers.OpenRegisterWindow);$("#btnRegisterUser").click(RegisterHandlers_1.RegisterHandlers.RegisterUser);$("#btnLogin").click(LogonHandlers_1.LogonHandlers.OpenLogonWindow);$("#btnLoginUser").click(LogonHandlers_1.LogonHandlers.LoginLogout);$("#btnLoadTL").click(LoadTimeLine)})();Object.defineProperty(exports,"__esModule",{value:!0});Globals_1=require("./Globals");LogonHandlers=function(){function n(){}return n.OpenLogonWindow=function(){return Globals_1.Globals.IsAuthentificated?$.ajax("api/register/logout").done(function(n){n&&(Globals_1.Globals.IsAuthentificated=!1,$("#btnLogin").text("Вход"),$("#lblUser").css("display","none"),$("#lblUser").text(""))}):($("#logLogin").val(Globals_1.Globals.getCookie("timelineuser")||""),$("#logPassword").val(""),$("#tmLoginModal").modal(),$("#log_server_error").css("display","none")),!1},n.LoginLogout=function(){$("#logLogin")[0].reportValidity()&&$("#logPassword")[0].reportValidity()&&$.ajax("api/register/log",{type:"POST",data:{Login:$("#logLogin").val(),Password:$("#logPassword").val()}}).done(function(n){n===""?(Globals_1.Globals.IsAuthentificated=!0,$("#tmLoginModal").modal("hide"),$("#btnLogin").text("Выход"),$("#lblUser").css("display","unset"),$("#lblUser").text($("#logLogin").val())):($("#log_server_error").text(n),$("#log_server_error").css("display","unset"))})},n}();exports.LogonHandlers=LogonHandlers;Object.defineProperty(exports,"__esModule",{value:!0});RegisterHandlers=function(){function n(){}return n.OpenRegisterWindow=function(){return $("#regLogin").val(""),$("#regEmail").val(""),$("#regPassword1").val(""),$("#regPassword2").val(""),$("#tmRegisterModal").modal(),$("#passw_not_matches").css("display","none"),$("#reg_server_error").css("display","none"),!1},n.RegisterUser=function(){$("#regLogin")[0].reportValidity()&&$("#regEmail")[0].reportValidity()&&$("#regPassword1")[0].reportValidity()&&$("#regPassword2")[0].reportValidity()&&($("#regPassword1").val()===$("#regPassword2").val()?$.ajax("api/register/reg",{type:"POST",data:{Login:$("#regLogin").val(),Email:$("#regEmail").val(),Password1:$("#regPassword1").val(),Password2:$("#regPassword2").val()}}).done(function(n){n===""?$("#tmRegisterModal").modal("hide"):($("#reg_server_error").text(n),$("#reg_server_error").css("display","unset"))}):$("#passw_not_matches").css("display","unset"))},n}();exports.RegisterHandlers=RegisterHandlers;Object.defineProperty(exports,"__esModule",{value:!0});exports.saaGraph=function(){return{roundedRect:function(n,t,i,r,u,f){n.beginPath();n.moveTo(t,i+f);n.lineTo(t,i+u);n.lineTo(t+r,i+u);n.lineTo(t+r,i+f);n.quadraticCurveTo(t+r,i,t+r-f,i);n.lineTo(t+f,i);n.quadraticCurveTo(t,i,t,i+f);n.fill()}}}();Object.defineProperty(exports,"__esModule",{value:!0});exports.stringUtils=function(){return{pad:function(n,t){for(var i=n+"";i.length<t;)i="0"+i;return i}}}();Object.defineProperty(exports,"__esModule",{value:!0});var dateutils_1=require("./dateutils"),saagraph_1=require("./saagraph"),TLEvent_1=require("./TLEvent"),TimeLine=function(){function n(t,i,r,u,f,e,o){i===void 0&&(i=null);r===void 0&&(r=0);u===void 0&&(u=null);f===void 0&&(f=null);e===void 0&&(e="нет имени");o===void 0&&(o=[]);this.ctx=t;this.curPeriod=i;this.x=t.canvas.clientWidth-1+n.INTERVAL_WIDTH+.5;this.y=r;this.color=u;this.period=f;this.name=e;this.data=o}return n.getList=function(){return new Promise(function(n,t){$.ajax("api/storage/list").done(function(t){n(t)}).fail(function(n){t(n.responseText)})})},n.prototype.save=function(){$.ajax("api/storage/save",{method:"POST",data:{s1:this.name,s2:JSON.stringify(this.tldata)}}).done(function(){alert("Сохранение прошло успешно.")}).fail(function(n){alert("Ошибка при сохранении.\n"+n.responseText)})},Object.defineProperty(n.prototype,"Period",{set:function(t){this.x=this.ctx.canvas.clientWidth-1+n.INTERVAL_WIDTH+.5;this.curPeriod=n.getCurPeriod(t);this.period=t},enumerable:!0,configurable:!0}),n.prototype.draw=function(){this.data=[];this.curdata=-1;for(var t=this.x,i=this.curPeriod;t>=0;)this.drawCell(t,i),t-=n.INTERVAL_WIDTH,i=this.getPeriodAgo(i,-1);for(t=this.x,i=this.curPeriod;t<=this.ctx.canvas.clientWidth-1+n.INTERVAL_WIDTH;)this.drawCell(t,i),t+=n.INTERVAL_WIDTH,i=this.getPeriodAgo(i,1);this.drawName()},n.prototype.findperiods=function(n){var i=this,t=[];return this.tldata.Periods.forEach(function(r){r.Contains(i.period,n)&&t.push(r)}),t},n.prototype.drawName=function(){var n=30,t=10,i;this.ctx.save();this.ctx.fillStyle=this.color;this.ctx.textBaseline="middle";this.ctx.textAlign="center";this.ctx.font="16px serif";i=this.ctx.measureText(this.name).width+t/2;saagraph_1.saaGraph.roundedRect(this.ctx,t,this.y-n,i,n,10);this.ctx.fillStyle="white";this.ctx.fillText(this.name,t+i/2,this.y-n/2);this.ctx.restore()},n.prototype.drawCell=function(t,i){var r=new Path2D,u;r.rect(t-n.INTERVAL_WIDTH+1,this.y,n.INTERVAL_WIDTH,n.LINE_THICKNESS);this.ctx.fillStyle=this.color;this.ctx.strokeStyle="white";this.ctx.fill(r);this.ctx.stroke(r);this.ctx.textBaseline="middle";this.ctx.textAlign="center";this.ctx.font="14px serif";this.ctx.fillStyle="white";this.ctx.fillText(this.formatPeriod(i),t-n.HALF_INTERVAL_WIDTH,this.y+n.HALF_LINE_THICKNESS);u=new CellData(i,t-n.INTERVAL_WIDTH+1,this.y,t,this.y+n.LINE_THICKNESS-1,r);u.periods=this.findperiods(i);this.data.push(u)},n.prototype.getCellValue=function(n,t){for(var i=0;i<this.data.length;i++)if(n>this.data[i].x1&&n<this.data[i].x2&&t>this.data[i].y1&&t<this.data[i].y2)return i;return-1},n.prototype.onBox=function(n){var t=this.data[n];this.ctx.strokeStyle="black";this.ctx.stroke(t.path)},n.prototype.offBox=function(){var n=this.data[this.curdata];this.ctx.strokeStyle="white";this.ctx.stroke(n.path)},n.prototype.shift=function(n){this.x+=n},n.getCurPeriod=function(n){var t;switch(n){case TLEvent_1.EnumPeriod.month:t=dateutils_1.DateUtils.getMonthFromDate(dateutils_1.DateUtils.getCurDate());break;case TLEvent_1.EnumPeriod.year:t=dateutils_1.DateUtils.getYearFromDate(dateutils_1.DateUtils.getCurDate());break;case TLEvent_1.EnumPeriod.decade:t=dateutils_1.DateUtils.getDecadeFromDate(dateutils_1.DateUtils.getCurDate());break;case TLEvent_1.EnumPeriod.century:t=dateutils_1.DateUtils.getCenturyFromDate(dateutils_1.DateUtils.getCurDate());break;case TLEvent_1.EnumPeriod.day:default:t=dateutils_1.DateUtils.getCurDate()}return t},n.prototype.formatPeriod=function(n){var t;switch(this.period){case TLEvent_1.EnumPeriod.month:t=dateutils_1.DateUtils.formatMonth(n);break;case TLEvent_1.EnumPeriod.year:t=dateutils_1.DateUtils.formatYear(n);break;case TLEvent_1.EnumPeriod.decade:t=dateutils_1.DateUtils.formatDecade(n);break;case TLEvent_1.EnumPeriod.century:t=dateutils_1.DateUtils.formatCentury(n);break;case TLEvent_1.EnumPeriod.day:default:t=dateutils_1.DateUtils.formatDate(n)}return t},n.prototype.getPeriodAgo=function(n,t){var i;switch(this.period){case TLEvent_1.EnumPeriod.month:case TLEvent_1.EnumPeriod.year:case TLEvent_1.EnumPeriod.decade:i=n+t;break;case TLEvent_1.EnumPeriod.century:i=n+t;i===0&&(i=i+t);break;case TLEvent_1.EnumPeriod.day:default:i=dateutils_1.DateUtils.getDateAgo(n,t)}return i},n.LINE_THICKNESS=25,n.HALF_LINE_THICKNESS=n.LINE_THICKNESS/2,n.INTERVAL_WIDTH=100,n.HALF_INTERVAL_WIDTH=n.INTERVAL_WIDTH/2,n}();exports.TimeLine=TimeLine;CellData=function(){function n(n,t,i,r,u,f){this.value=n;this.x1=t;this.y1=i;this.x2=r;this.y2=u;this.path=f}return n}();__extends=this&&this.__extends||function(){var n=function(t,i){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},n(t,i)};return function(t,i){function r(){this.constructor=t}n(t,i);t.prototype=i===null?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});dateutils_1=require("./dateutils"),function(n){n[n.day=1]="day";n[n.month=2]="month";n[n.year=3]="year";n[n.decade=4]="decade";n[n.century=5]="century"}(EnumPeriod=exports.EnumPeriod||(exports.EnumPeriod={}));TLDate=function(){function n(n,t,i,r){var f,u;if(r===undefined){if(n==0)throw new Error("Год равен 0");if(t>12||t<1)throw new Error("Неверный месяц месяца");if(i<1)throw new Error("День меньше 1");if([1,3,5,7,8,10,12].includes(t)){if(i>31)throw new Error("Неверный день месяца");}else if([4,6,9,11].includes(t)){if(i>30)throw new Error("Неверный день месяца");}else{if(i>29)throw new Error("Неверный день месяца");if(n>=1&&n<=9999)if(f=new Date(n,t-1,i),dateutils_1.DateUtils.leapYear(n)){if(i>27)throw new Error("Неверный день месяца");}else if(i>28)throw new Error("Неверный день месяца");}this.Day=i;this.Month=t;this.Year=n;this.FromCrismas=dateutils_1.DateUtils.DaysFromAD(n,t,i)}else this.FromCrismas=r,u=dateutils_1.DateUtils.YMDFromAD(r),this.Day=u.day,this.Month=u.month,this.Year=u.year}return n.prototype.Greater=function(n){return this.FromCrismas>n.FromCrismas},n.prototype.GreaterOrEqual=function(n){return this.FromCrismas>=n.FromCrismas},n.prototype.Less=function(n){return this.FromCrismas<n.FromCrismas},n.prototype.LessOrEqual=function(n){return this.FromCrismas<=n.FromCrismas},n.prototype.Equal=function(n){return this.FromCrismas===n.FromCrismas},n.prototype.AddDays=function(t){return new n(null,null,null,this.FromCrismas+t)},n.prototype.AddMonths=function(t){for(var r,u,i,e=dateutils_1.DateUtils.makeMonthNumber(this.Year,this.Month,t<0),f=0;f<t;f++)i=e.next().value;for(r=this.Day;;)try{u=new n(i.year,i.month,r);break}catch(o){r--;continue}return u},n}();TLEvent=function(){function n(n){this.Name=n;this.Day=null;this.Month=null;this.Year=null;this.Decade=null;this.Century=null}return n.prototype.DecadeFromYear=function(n){return n/10+n/Math.abs(n)},n.prototype.CenturyFromDecade=function(n){return n/10+n/Math.abs(n)},n.prototype.YearFromMonth=function(n){return(n-1)/12+n/Math.abs(n)},n.GetType=function(n){return n.Day!==null?EnumPeriod.day:n.Month!==null?EnumPeriod.month:n.Year!==null?EnumPeriod.year:n.Decade!==null?EnumPeriod.decade:n.Century!==null?EnumPeriod.century:void 0},n.Equal=function(n,t){var i=!1;return n.Century===t.Century&&n.Decade===t.Decade&&n.Year===t.Year&&n.Month===t.Month&&n.Day.Year===t.Day.Year&&n.Day.Month===t.Day.Month&&n.Day.Day===t.Day.Day&&(i=!0),i},n}();exports.TLEvent=TLEvent;TLEventDay=function(n){function t(t,i,r,u){var f=n.call(this,t)||this;return f.Day=new TLDate(i,r,u),f.Month=((Math.abs(i)-1)*12+r)*(i/Math.abs(i)),f.Year=i,f.Decade=f.DecadeFromYear(i),f.Century=f.CenturyFromDecade(f.Decade),f.Type=EnumPeriod.day,f}return __extends(t,n),t}(TLEvent);exports.TLEventDay=TLEventDay;TLEventMonth=function(n){function t(t,i,r){var u=n.call(this,t)||this,f,e;return r!==undefined?(f=i,e=r,u.Month=((Math.abs(f)-1)*12+e)*(f/Math.abs(f)),u.Year=f,u.Decade=u.DecadeFromYear(f),u.Century=u.CenturyFromDecade(u.Decade)):(e=i,u.Month=e,u.Year=u.YearFromMonth(e),u.Decade=u.DecadeFromYear(u.Year),u.Century=u.CenturyFromDecade(u.Decade)),u.Type=EnumPeriod.month,u}return __extends(t,n),t}(TLEvent);exports.TLEventMonth=TLEventMonth;TLEventYear=function(n){function t(t,i){var r=n.call(this,t)||this;return r.Year=i,r.Decade=r.DecadeFromYear(i),r.Century=r.CenturyFromDecade(r.Decade),r.Type=EnumPeriod.year,r}return __extends(t,n),t}(TLEvent);exports.TLEventYear=TLEventYear;TLEventDecade=function(n){function t(t,i,r){var u=n.call(this,t)||this,e,f;if(r!==undefined){if(e=i,f=r,f<0||f>9)throw Error("Неверный номер десятилетия");u.Decade=((Math.abs(e)-1)*10+f+1)*(e/Math.abs(e));u.Century=e}else f=i,u.Decade=f,u.Century=u.CenturyFromDecade(f);return u.Type=EnumPeriod.decade,u}return __extends(t,n),t}(TLEvent);exports.TLEventDecade=TLEventDecade;TLEventCentury=function(n){function t(t,i){var r=n.call(this,t)||this;return r.Century=i,r.Type=EnumPeriod.century,r}return __extends(t,n),t}(TLEvent);exports.TLEventCentury=TLEventCentury;TLPeriod=function(){function n(n){this.Name=n.Name;var t;t=TLEvent.GetType(n.Begin);t===EnumPeriod.day?this.Begin=new TLEventDay(n.Begin.Name,n.Begin.Day.Year,n.Begin.Day.Month,n.Begin.Day.Day):t===EnumPeriod.month?this.Begin=new TLEventMonth(n.Begin.Name,n.Begin.Month):t===EnumPeriod.year?this.Begin=new TLEventYear(n.Begin.Name,n.Begin.Year):t===EnumPeriod.decade?this.Begin=new TLEventDecade(n.Begin.Name,n.Begin.Decade):t===EnumPeriod.century&&(this.Begin=new TLEventCentury(n.Begin.Name,n.Begin.Century));t=TLEvent.GetType(n.End);t===EnumPeriod.day?this.End=new TLEventDay(n.End.Name,n.End.Day.Year,n.End.Day.Month,n.End.Day.Day):t===EnumPeriod.month?this.End=new TLEventMonth(n.End.Name,n.End.Month):t===EnumPeriod.year?this.End=new TLEventYear(n.End.Name,n.End.Year):t===EnumPeriod.decade?this.End=new TLEventDecade(n.End.Name,n.End.Decade):t===EnumPeriod.century&&(this.End=new TLEventCentury(n.End.Name,n.End.Century))}return n.prototype.Contains=function(n,t){var r=!1,i;switch(n){case EnumPeriod.day:i=t;r=this.ContainsDay(new TLDate(i.getFullYear(),i.getMonth()+1,i.getDate()))}return r},n.prototype.ContainsDay=function(n){var t,i;switch(this.Begin.Type){case EnumPeriod.day:t=this.Begin.Day;break;case EnumPeriod.month:t=new TLDate(this.Begin.Day.Year,this.Begin.Day.Month,1);break;case EnumPeriod.year:t=new TLDate(this.Begin.Day.Year,1,1);break;case EnumPeriod.decade:t=new TLDate(Math.floor(this.Begin.Year/10)+1,1,1);break;case EnumPeriod.century:t=new TLDate(Math.floor(this.Begin.Year/100)+1,1,1)}switch(this.End.Type){case EnumPeriod.day:i=this.End.Day;break;case EnumPeriod.month:i=new TLDate(this.Begin.Day.Year,this.Begin.Day.Month,1);break;case EnumPeriod.year:i=new TLDate(this.Begin.Day.Year,1,1);break;case EnumPeriod.decade:i=new TLDate(Math.floor(this.Begin.Year/10)+1,1,1);break;case EnumPeriod.century:i=new TLDate(Math.floor(this.Begin.Year/100)+1,1,1)}return n.GreaterOrEqual(t)&&n.LessOrEqual(i)},n}();exports.TLPeriod=TLPeriod;TimeLineData=function(){function n(n){var t=this;this.Periods=[];this.Name=n.Name;n.Periods.forEach(function(n){TLEvent.Equal(n.Begin,n.End)?t.Periods.push(new TLPeriodEvent(n)):t.Periods.push(new TLPeriod(n))})}return n}();exports.TimeLineData=TimeLineData;TLPeriodEvent=function(n){function t(t){return n.call(this,t)||this}return __extends(t,n),t}(TLPeriod);exports.TLPeriodEvent=TLPeriodEvent;
//# sourceMappingURL=main.min.js.map